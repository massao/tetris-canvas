function Block(e){var t=10,o=250;this.block_size=Math.ceil(o/t),this.ctx=e}function Piece(){this.blocks=[],this.x=3,this.y=0,this.type="",this.rotation="up",this.rotationEnabled=!0,this.pieces={L:{name:"L",pos:{up:"4460",left:"2E00",down:"6220",right:"E800"},color:"#f0a001"},I:{name:"I",pos:{up:"4444",left:"0F00",down:"4444",right:"0F00"},color:"#00f0ef"},S:{name:"S",pos:{up:"3600",left:"4620",down:"3600",right:"4620"},color:"#01f000"},T:{name:"T",pos:{up:"E400",left:"4C40",down:"4E00",right:"4640"},color:"#9f00f0"},J:{name:"J",pos:{up:"2260",left:"E200",down:"6440",right:"8E00"},color:"#0000f0"},Z:{name:"Z",pos:{up:"C600",left:"4C80",down:"C600",right:"4C80"},color:"#f00001"},O:{name:"O",pos:{up:"6600",left:"6600",down:"6600",right:"6600"},color:"#f1f000"}}}function Game(){this.canvas=document.getElementById("game"),this.ctx=this.canvas.getContext("2d"),this.started=!1,this.pieces=[],this.newPiece=!1,this.score=0,this.t,this.paused=!0;var e=this,t=this.pieces,o=this.ctx,s=function(){e.loop(this.ctx)};e.start=function(){e=this,t=e.pieces,o=e.ctx,e.started=!0,e.newPiece=!0,e.loop(e.ctx),e.paused=!1,e.bindKeys(),e.t=setInterval(s,500)},e.binds=function(s){var i=t[t.length-1],n=!1,r=0,c=19,a=3,l=0,p=9;switch(s.keyCode){case 38:i.rotate(t);for(b in i.blocks)blocks=i.blocks,r=blocks[b].y>r?blocks[b].y:r;i.y+r>=c&&(i.rotationEnabled=!1),n=!0;break;case 40:e.loop(),n=!0;break;case 37:for(b in i.blocks)blocks=i.blocks,a=blocks[b].x<a?blocks[b].x:a;0<i.x+a&&e.checkMove("left")&&i.move(0,-1),n=!0;break;case 39:for(b in i.blocks)blocks=i.blocks,l=blocks[b].x>l?blocks[b].x:l;p>i.x+l&&e.checkMove("right")&&i.move(0,1),n=!0}o.save(),o.clearRect(0,0,canvas.width,canvas.height);for(x in t)t[x].draw();o.restore(),1==n&&(s.preventDefault&&s.preventDefault(),s.returnValue=!1)},e.pause=function(t){80==t.keyCode&&(e.togglePause(),t.preventDefault&&t.preventDefault())},e.bindKeys=function(){document.addEventListener("keydown",e.binds,!1),document.addEventListener("keyup",e.pause,!1)}}Block.prototype.drawBlock=function(e,t,o,s){s=s||this.ctx,e*=this.block_size,t*=this.block_size,s.fillStyle=o,s.fillRect(e,t,this.block_size,this.block_size)},Piece.prototype={getType:function(){var e=[this.pieces.L,this.pieces.I,this.pieces.S,this.pieces.T,this.pieces.J,this.pieces.Z,this.pieces.O];return e[Math.floor(Math.random()*e.length)]},move:function(e,t){this.rotationEnabled&&(_y=e||0,_x=t||0,this.y+=_y,this.x+=_x)},prepare:function(e){var t=this.getType(),o=t.pos[this.rotation],s=o.split("");for(g in s){for(var i=parseInt(s[g],16).toString(2);i.length<4;)i="0"+i;s[g]=i,o=s[g].split("");for(p in o)if(1==o[p]){x=parseInt(p,10),y=parseInt(g,10);var n=new Block(e);this.blocks.push({x:x,y:y,b:n})}}this.type=t},draw:function(e){blocks=this.blocks,type=this.type;for(b in blocks)block=blocks[b],x=block.x+parseInt(this.x,10),y=block.y+parseInt(this.y,10),block.b.drawBlock(x,y,type.color,e)},rotate:function(e){if(this.rotationEnabled){switch(this.rotation){case"up":this.rotation="left";break;case"left":this.rotation="down";break;case"down":this.rotation="right";break;case"right":this.rotation="up"}var t=!1,o=type.pos[this.rotation],s=o.split(""),i=0;for(g in s){for(var n=parseInt(s[g],16).toString(2);n.length<4;)n="0"+n;s[g]=n,o=s[g].split("");for(p in o)1==o[p]&&(f=parseInt(p,10),y=parseInt(g,10),f+this.x>9&&this.move(0,-1),f+this.x<0&&this.move(0,1),y+this.y>19&&(t=!0),a=this.blocks[i],a.x=f,a.y=y,i++);var r=this,c=this.blocks;for(b in c)for(var a=c[b],l=a.x+r.x,h=a.y+r.y,f=0;f<e.length-1;f++){var v=e[f],d=e[f].blocks;for(ob in d){var u=d[ob],k=u.x+v.x,x=u.y+v.y;l==k&&h==x&&(t=!0)}}}if(t){switch(this.rotation){case"up":this.rotation="right";break;case"left":this.rotation="up";break;case"down":this.rotation="left";break;case"right":this.rotation="down"}var o=type.pos[this.rotation],s=o.split(""),i=0;for(g in s){for(var n=parseInt(s[g],16).toString(2);n.length<4;)n="0"+n;s[g]=n,o=s[g].split("");for(p in o)1==o[p]&&(f=parseInt(p,10),y=parseInt(g,10),f+this.x>9&&this.move(0,-1),f+this.x<0&&this.move(0,1),a=this.blocks[i],a.x=f,a.y=y,i++)}}}}},Game.prototype={draw:function(e){var t=this;if(_ctx=e||t.ctx,canvas=t.canvas,_ctx.save(),_ctx.clearRect(0,0,canvas.width,canvas.height),t.newPiece){var o=new Piece;o.prepare(_ctx,"down"),t.pieces.push(o),t.newPiece=!1}else{var o=t.pieces[t.pieces.length-1];t.checkStep()?o.move(1,0):(o.rotationEnabled=!1,t.newPiece=!0,t.checkLines())}for(o in t.pieces)pieces=t.pieces,pieces[o].draw();_ctx.restore()},loop:function(e){var t=this;t.started&&!t.paused?t.draw(e):console.log("nope")},checkStep:function(){var e=this,t=!0,o=e.pieces[e.pieces.length-1],s=0,n=18,t=!0,r=0,c=0;for(b in o.blocks){blocks=o.blocks,s=blocks[b].y>s?blocks[b].y:s,r=blocks[b].y+o.y,c=blocks[b].x+o.x;for(var a=0;a<e.pieces.length-1;a++){var l=e.pieces,p=0,h=0;for(i in l[a].blocks){var f=l[a].blocks;p=f[i].y,h=f[i].x,r+1==l[a].y+p&&c==l[a].x+h&&(t=!1)}}o.y+s>n&&(t=!1)}return t},checkLines:function(){var e=this;for(x=0;x<20;x++){for(var t=[],o=0;10>o;)t.push(0),o++;var s=e.pieces;for(p in s){var i=s[p],n=i.blocks;for(b in n){var c=n[b];c.y+i.y==x&&(t[c.x+i.x]=1)}}var a=!0;for(space in t)0==t[space]&&(a=!1),0==x&&1==t[4]&&e.gameOver();if(a){e.updateScore(10);for(p in s){var i=s[p],n=i.blocks,l=[];for(b in n){var c=n[b];c.y+i.y==x?l.push(b):c.y+i.y<x&&(c.y=c.y+1)}l.sort(function(e,t){return t-e});for(r in l)n.splice(l[r],1)}}}},checkMove:function(e){var t=this,o=t.pieces[t.pieces.length-1],s=t.pieces,i=!0,n=o.blocks;for(b in n)for(var r=n[b],c=r.x+o.x,a=r.y+o.y,l=0;l<s.length-1;l++){var p=s[l],h=s[l].blocks;for(ob in h){var f=h[ob],v=f.x+p.x,d=f.y+p.y;"left"==e&&c-1==v&&a==d&&(i=!1),"right"==e&&c+1==v&&a==d&&(i=!1)}}return i},togglePause:function(){var e=this;e.paused?document.addEventListener("keydown",e.binds,!1):(e.ctx.fillStyle="rgba(0,0,0,0.5)",e.ctx.fillRect(0,0,e.canvas.width,e.canvas.height),document.removeEventListener("keydown",e.binds,!1)),e.paused=e.paused?!1:!0},gameOver:function(){alert("Game over.\nPress 'space' to play again");var e=this;e.canvas=document.getElementById("game"),e.ctx=e.canvas.getContext("2d"),e.draw(),e.started=!1,e.pieces=[],e.newPiece=!1,document.removeEventListener("keydown",e.binds,!1),clearInterval(e.t);var t=function(o){32==o.keyCode&&(e.start(),document.removeEventListener("keydown",t,!1),o.preventDefault&&o.preventDefault(),o.returnValue=!1)};document.addEventListener("keydown",t,!1)},updateScore:function(e){var t=document.querySelector(".score"),o=t.querySelector("span");o.innerHTML=parseInt(o.innerHTML,10)+e}};var g=new Game;g.start();